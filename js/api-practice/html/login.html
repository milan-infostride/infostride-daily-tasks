<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log in</title>
    <script src="https://kit.fontawesome.com/16139588c8.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-4">Login...!!</h1>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-11 col-lg-8 rounded bg-dark text-light p-4 ">
                <div class="text-center text-warning">
                    <i class="fas fa-user display-2"></i>
                    <!-- <i class="fas fa-lock display-2"></i> -->
                </div>

                <form class="col-lg-8 col-10 mx-auto">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" aria-describedby="email">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" aria-describedby="password">
                    </div>
                </form>
                <div class="text-center mt-4">
                    <button class="btn btn-lg btn-warning" id="loginButton">Login</button>
                </div>
            </div>
        </div>

    </div>
    

    <script>
        // let email =
        let email = document.getElementById('email'); 
        let password = document.getElementById('password');
        let loginData;
        let user;
        function chkEmail(email){
            return email.match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
        }
        let loginButton = document.getElementById('loginButton');
        loginButton.addEventListener('click',()=>{
            loginData = {
                email: email.value.toLowerCase(),
                password: password.value

            }
        
            let chk = true;
            for(let prop in loginData){
                if(loginData[prop].length==0){
                    alert(prop.replaceAll('_',' ')+' is empty');
                    chk = false;
                    break;
                }
            }
            if(!chkEmail(loginData.email)){
                alert('email invalid');
                chk = false;
            }
            if(chk){
                async function login(){
                    let resource = 'http://localhost:3000/users';

                    let urlEmail = resource + '?email='+loginData.email;
                    await fetch(urlEmail).then(res=>{
                        if(res.status==200)
                            return res.json();
                        throw new Error('some error occured');
                    }).then(res=>{
                        console.log(res);
                        user = res;
                    }).catch(err=>{
                        alert(err);
                    })
                    if(user.length>0){
                        let currentUser = user[0]
                        if(loginData.password==currentUser.password){
                            delete currentUser.password;
                            localStorage.setItem('currentUser',JSON.stringify(currentUser));
                            // alert('logged in successfull');
                            location.replace('welcome-user.html')
                        }
                        else{
                            alert('password didn\'t matched');
                        }

                    }
                    else{
                        alert('no user present with that email')
                    }
                }
                login();
            }

        })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

</body>
</html>