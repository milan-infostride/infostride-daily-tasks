<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signup</title>
    <script src="https://kit.fontawesome.com/16139588c8.js" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">

</head>
<body>

    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="display-4">Signup...!!</h1>
            </div>
        </div>
        <div class="row justify-content-center mb-5">
            <div class="col-lg-8 col-11 rounded bg-dark text-light p-4 ">
                <div class="text-center">
                    <!-- <i class="fas fa-user display-4"></i> -->
                    <!-- <i class="fas fa-user display-3"></i> -->
                    <i class="fas fa-user text-success display-2"></i>
                </div>
                <form class="col-lg-8 col-10 mx-auto">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" aria-describedby="email">
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" aria-describedby="name">
                    </div>
                    <div class="mb-3">
                        <label for="number" class="form-label">Number</label>
                        <input type="tel" class="form-control" id="number" aria-describedby="number">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" aria-describedby="password">
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirmPassword" aria-describedby="password">
                    </div>
                </form>
                <div class="text-center mt-4">
                    <button class="btn btn-lg btn-success" id="signupButton">Sign up</button>
                </div>

            </div>

        </div>

    </div>




    <script>
        let email = document.getElementById('email');
        let name = document.getElementById('name');
        let number = document.getElementById('number');
        let password = document.getElementById('password');
        let confirmPassword = document.getElementById('confirmPassword');
        let signupButton = document.getElementById('signupButton');
        let signupData;
        function chkPhoneNumber(number){
            if(isNaN(number))
                return false;
            if(number.length!=10){
                return false;
            }
            return true;
        }
        function chkPassword(str1,str2){
            return str1==str2;
        }
        function chkEmail(email){
            return email.match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
        }
        signupButton.addEventListener('click',()=>{
            signupData = {
                email: email.value.toLowerCase(),
                name: name.value,
                number: number.value,
                password: password.value,
                confirm_Password: confirmPassword.value
            }
            console.log('signup data = ',signupData);
            let chk = true;
            for(let prop in signupData){
                if(signupData[prop].length==0){
                    alert(prop.replaceAll('_',' ')+' is empty');
                    chk = false;
                    break;
                }
            }
            if(!chkPhoneNumber(signupData.number)){
                alert('phone number invalid');
                chk = false;
            }
            if(!chkEmail(signupData.email)){
                alert('email invalid');
                chk = false;
            }
            if(!chkPassword(signupData.password,signupData.confirm_Password)){
                alert('password and confirm password dosen\'t matched');
                chk = false;
            }
            if(chk){
                //code to send data to users.json
                // resource link :- http://localhost:3000/users
                let resource = 'http://localhost:3000/users';
                async function signup(){
                    let urlEmail = resource + '?email='+signupData.email;
                    let posturl = resource;
                    let emailResult = [];
                    await fetch(urlEmail).then(res=>{
                        console.log("in response");
                        console.log(res);
                        if(res.status==200)
                            return res.json();
                        else throw new Error("some error occurred");
                    }).then(res=>{
                        console.log("result = ",res);
                        emailResult = res;
                    }).catch(err=>{
                        alert(err.message());
                    })
                    if(emailResult.length==0){
                        delete signupData.confirm_password;
                        await fetch(posturl,{
                            method: "POST",
                            headers: {
                                "Content-type": "application/json; charset=UTF-8"
                            },
                            body: JSON.stringify(signupData)}).then(res=>{
                                console.log(res);
                                if(res.status==201)
                                    return res.json();
                                else{
                                    throw new Error("some error occured");
                                }
                            }).then(res=>{
                                console.log(res);
                                // let redirecturl = location.href
                                location.replace('login.html');
                            }).catch(err=>{
                                alert(err);
                            });
                    }
                    else{
                        alert('user already present');
                    }
                }
                signup();
            }
            
        })
        
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

</body>
</html>