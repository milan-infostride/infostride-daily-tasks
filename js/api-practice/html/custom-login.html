<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>custom-login</title>
    <link rel="stylesheet" href="../css/navbar.css">
    <link rel="stylesheet" href="../css/login-signup.css">


</head>
<body>
    <nav>
        <div class="logo">LOGO</div>
        <ul class="collapsing-content">
            <li class="upper-li">Hello <span id="username"></span></li>
            <li class="upper-li" id="logout" style="display: none;"><a href="#" class="nav-link">Logout</a></li>
            <li class="my-dropdown upper-li" id="login" style="display: none;"><a href="#" class="dropbtn nav-link">Login/Signup <i class="fa-solid fa-caret-down"></i></a>
            <ul class="dropdown-content">
                <li><a href="custom-login.html" class="nav-link">Login</a></li>
                <li><a href="custom-signup.html" class="nav-link">Signup</a></li>
            </ul>
             </li>
        </ul>
    </nav>
    <section class="my-login-container">
        <div class="my-login-col" id="login-col">
            <div class="login-heading">
                Login...!!
            </div>
            <div class="login-form">
                <input type="email" class="form-input" id="email" placeholder="email"><br>
                <input type="password" class="form-input" id="password" placeholder="password">
            </div>
            <span class="login-btn" id="loginButton">Login</span>


        </div>
    </section>

    <script>
        let dropContent = document.getElementsByClassName('dropdown-content');
        let dropbtn = document.getElementsByClassName('my-dropdown');
        dropbtn[0].addEventListener('click',(e)=>{
            // console.log(e)
            // console.log(dropContent[0]);
            dropContent[0].classList.toggle('show');
        })
        let loggedIn = false;
        let userName = document.getElementById('username');

        let logincol = document.getElementById('login-col');
        if(localStorage.getItem('currentUser')){
            let currentUser = JSON.parse(localStorage.getItem('currentUser'))
            loggedIn = true;
            let logout = document.getElementById('logout');
            // console.log(logout);
            logout.style['display'] = "list-item";
            logout.addEventListener('click',()=>{
                localStorage.removeItem('currentUser');
                location.reload();
            })
            logincol.style['display'] = 'none';
            userName.innerText = currentUser.name;
        }
        else{
        let login = document.getElementById('login');
        login.style['display'] = "list-item";
        userName.innerText = 'Guest';
        let email = document.getElementById('email'); 
        let password = document.getElementById('password');
        let loginData;
        let user;
        function chkEmail(email){
            return email.match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
        }
        let loginButton = document.getElementById('loginButton');
        loginButton.addEventListener('click',()=>{
            loginData = {
                email: email.value.toLowerCase(),
                password: password.value

            }
        
            let chk = true;
            for(let prop in loginData){
                if(loginData[prop].length==0){
                    alert(prop.replaceAll('_',' ')+' is empty');
                    chk = false;
                    break;
                }
            }
            if(!chkEmail(loginData.email)){
                alert('email invalid');
                chk = false;
            }
            if(chk){
                async function login(){
                    let resource = 'http://localhost:3000/users';

                    let urlEmail = resource + '?email='+loginData.email;
                    await fetch(urlEmail).then(res=>{
                        if(res.status==200)
                            return res.json();
                        throw new Error('some error occured');
                    }).then(res=>{
                        // console.log(res);
                        user = res;
                    }).catch(err=>{
                        alert(err);
                    })
                    if(user.length>0){
                        let currentUser = user[0]
                        if(loginData.password==currentUser.password){
                            delete currentUser.password;
                            // delete
                            localStorage.setItem('currentUser',JSON.stringify(currentUser));
                            // alert('logged in successfull');
                            location.replace('welcome-user.html')
                        }
                        else{
                            alert('password didn\'t matched');
                        }

                    }
                    else{
                        alert('no user present with that email')
                    }
                }
                login();
            }

        })
        }
    </script>
</body>
</html>